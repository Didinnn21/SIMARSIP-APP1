<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Data Peralatan - BAA</title>
    <link rel="stylesheet" href="https://cdn.framework7.io/framework7/5.7.10/css/framework7.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background:#f4f7fb; font-family:-apple-system, sans-serif; margin:0; }
        .app-header { background:#007aff; color:white; padding:15px; display:flex; align-items:center; gap:10px; position: sticky; top: 0; z-index: 100; }
        .search-container { padding: 10px 16px; background: white; }
        .search-input { width: 100%; border: none; background: #f0f0f0; padding: 12px; border-radius: 10px; outline:none; }
        .section { padding:16px; padding-bottom: 100px; }
        .item-card { background:white; border-radius:15px; padding:15px; margin-bottom:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
        .item-main { display:flex; align-items:center; gap:15px; }
        .item-icon { width:40px; height:40px; background:#e3f2fd; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#007aff; }
        .item-info { flex:1; }
        .item-info h4 { margin:0; font-size:15px; color: #333; }
        .stock { font-weight:800; color:#007aff; font-size: 18px; }
        
        .item-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .btn-action { border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .btn-edit { background: #e3f2fd; color: #007aff; }
        .btn-delete { background: #ffebee; color: #ff3b30; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 14px; box-sizing: border-box; outline: none; }
        .btn-save { width: 100%; padding: 15px; background: #007aff; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }

        .fab-btn { position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px; background: linear-gradient(135deg, #007aff, #00dbde); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 15px rgba(0,122,255,0.4); cursor: pointer; z-index: 999; }
    </style>
</head>
<body>

    <div class="app-header">
        <i class="material-icons" style="cursor:pointer" onclick="window.location.href='index_baa.html'">arrow_back</i>
        <div style="font-weight:700; font-size:18px;">Inventaris Peralatan</div>
    </div>

    <div class="search-container">
        <input type="text" id="searchItem" class="search-input" placeholder="Cari peralatan..." onkeyup="filterItem()">
    </div>

    <div class="section" id="equipment-list"></div>

    <div class="fab-btn" onclick="openModal()">
        <i class="material-icons">add</i>
    </div>

    <div id="modalAlat" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Tambah Peralatan</h3>
                <i class="material-icons" style="cursor:pointer; color: #999;" onclick="closeModal()">close</i>
            </div>
            <input type="hidden" id="editId">
            <div class="form-group">
                <label>Nama Peralatan *</label>
                <input type="text" id="formNama">
            </div>
            <div class="form-group">
                <label>Jumlah Stok *</label>
                <input type="number" id="formStok">
            </div>
            <div class="form-group">
                <label>Kategori</label>
                <select id="formKategori">
                    <option value="Elektronik">Elektronik</option>
                    <option value="Furniture">Furniture</option>
                    <option value="Audio Visual">Audio Visual</option>
                    <option value="Olahraga">Olahraga</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div class="form-group">
                <label>Kondisi</label>
                <select id="formKondisi">
                    <option value="Baik">Baik</option>
                    <option value="Rusak Ringan">Rusak Ringan</option>
                    <option value="Rusak Berat">Rusak Berat</option>
                    <option value="Dalam Perbaikan">Dalam Perbaikan</option>
                </select>
            </div>
            <div class="form-group">
                <label>Keterangan (Opsional)</label>
                <textarea id="formKeterangan" rows="2"></textarea>
            </div>
            <button class="btn-save" onclick="saveAlat()">SIMPAN DATA</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBtyn-cjuhsnlEn-9Wao1tCcJfUQbf6GnY",
            authDomain: "simarsip-apk.firebaseapp.com",
            databaseURL: "https://simarsip-apk-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "simarsip-apk"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allItems = [];
        // Perbaikan: Tambahkan ID manual pada dummy agar bisa di-klik edit
        const dummyAlat = [
            { id: 'd-1', nama: "Proyektor Epson EB-X400", jumlah: 5, kondisi: "Baik", kategori: "Elektronik" },
            { id: 'd-2', nama: "Kamera DSLR Canon EOS 80D", jumlah: 2, kondisi: "Baik", kategori: "Audio Visual" }
        ];

        function loadData() {
            db.ref('master_peralatan').on('value', snap => {
                const fbAlat = [];
                snap.forEach(s => {
                    fbAlat.push({ id: s.key, ...s.val() });
                });
                allItems = [...dummyAlat, ...fbAlat];
                renderAlat(allItems);
            });
        }

        function renderAlat(data) {
            const list = document.getElementById('equipment-list');
            list.innerHTML = data.map(p => `
                <div class="item-card">
                    <div class="item-main">
                        <div class="item-icon"><i class="material-icons">devices</i></div>
                        <div class="item-info">
                            <h4>${p.nama}</h4>
                            <p style="margin:0; font-size:12px; color:gray;">${p.kategori || 'Alat'} â€¢ ${p.kondisi || 'Baik'}</p>
                        </div>
                        <div class="stock">${p.jumlah}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-action btn-edit" onclick="openModal('${p.id}')">
                            <i class="material-icons" style="font-size:14px">edit</i> Edit
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteAlat('${p.id}')">
                            <i class="material-icons" style="font-size:14px">delete</i> Hapus
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openModal(id = null) {
            document.getElementById('modalAlat').style.display = 'flex';
            const title = document.getElementById('modalTitle');
            const editIdInput = document.getElementById('editId');
            
            if(id && id !== "") {
                const item = allItems.find(i => i.id === id);
                if(item) {
                    title.innerText = "Edit Peralatan";
                    editIdInput.value = id;
                    document.getElementById('formNama').value = item.nama;
                    document.getElementById('formStok').value = item.jumlah;
                    document.getElementById('formKategori').value = item.kategori || "Elektronik";
                    document.getElementById('formKondisi').value = item.kondisi || "Baik";
                    document.getElementById('formKeterangan').value = item.keterangan || "";
                }
            } else {
                title.innerText = "Tambah Peralatan";
                editIdInput.value = "";
                document.getElementById('formNama').value = "";
                document.getElementById('formStok').value = "";
                document.getElementById('formKeterangan').value = "";
            }
        }

        function closeModal() { document.getElementById('modalAlat').style.display = 'none'; }

        function saveAlat() {
            const id = document.getElementById('editId').value;
            const payload = {
                nama: document.getElementById('formNama').value,
                jumlah: document.getElementById('formStok').value,
                kategori: document.getElementById('formKategori').value,
                kondisi: document.getElementById('formKondisi').value,
                keterangan: document.getElementById('formKeterangan').value
            };

            if(!payload.nama || !payload.jumlah) return alert("Mohon lengkapi data!");

            // Jika ID berawalan 'd-', itu data dummy (tidak bisa update ke Firebase)
            if(id && id.startsWith('d-')) {
                alert("Data bawaan (dummy) tidak bisa diubah di database.");
                closeModal();
                return;
            }

            if(id) {
                db.ref('master_peralatan').child(id).update(payload).then(() => {
                    alert("Data diperbarui!");
                    closeModal();
                });
            } else {
                db.ref('master_peralatan').push(payload).then(() => {
                    alert("Data ditambahkan!");
                    closeModal();
                });
            }
        }

        function deleteAlat(id) {
            if(id.startsWith('d-')) return alert("Data dummy tidak bisa dihapus.");
            if(confirm("Hapus peralatan ini?")) {
                db.ref('master_peralatan').child(id).remove();
            }
        }

        function filterItem() {
            const val = document.getElementById('searchItem').value.toLowerCase();
            renderAlat(allItems.filter(i => i.nama.toLowerCase().includes(val)));
        }

        loadData();
    </script>
</body>
</html>