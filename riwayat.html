<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Pengajuan</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@7/framework7-bundle.min.css">
    <style>
            body { background: #f1f4f9; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
            .page-header { background: #0a73ff; color: white; padding: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; }
            .tabs-container { display: flex; gap: 8px; padding: 10px; overflow-x: auto; }
            .tab-btn { padding: 6px 14px; border-radius: 20px; background: #e5e5e5; font-size: 14px; cursor: pointer; white-space: nowrap; transition: background 0.2s ease; }
            .tab-btn.active { background: #0a73ff; color: #fff; }
            
            a.card-link {
                text-decoration: none;
                color: inherit;
                display: block;
            }
    
            .card-item { background: white; padding: 15px; margin: 12px; border-radius: 12px; box-shadow: 0 3px 5px rgba(0,0,0,0.1); border-left: 5px solid #0a73ff; transition: transform 0.2s ease, box-shadow 0.2s ease; }
            .card-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 10px rgba(0,0,0,0.12);
            }
    
            .status { padding: 3px 10px; border-radius: 20px; font-size: 12px; float: right; margin-top: -5px; }
            .disetujui { background: #c9f7cd; color: #1f8b2e; }
            .menunggu { background: #ffe8a3; color: #a17400; }
            .ditolak { background: #ffd0d0; color: #b00000; }
            #riwayat-list { max-height: calc(100vh - 150px); overflow-y: auto; padding: 0 12px; }
            .empty-state { text-align: center; color: #888; margin-top: 50px; }
        </style>
    </head>
    <body>
    
        <div class="page-header">
            <span onclick="history.back()" style="cursor:pointer;">â¬…</span>
            Riwayat Lengkap
        </div>
    
        <!-- TAB -->
        <div class="tabs-container">
            <div class="tab-btn active" data-filter="all">Semua</div>
            <div class="tab-btn" data-filter="approved">Disetujui</div>
            <div class="tab-btn" data-filter="pending">Menunggu</div>
            <div class="tab-btn" data-filter="rejected">Ditolak</div>
        </div>
    
        <!-- LIST RIWAYAT -->
        <div id="riwayat-list">
            <!-- Data akan dirender di sini secara dinamis -->
            <div class="empty-state">Memuat riwayat...</div>
        </div>
    
        <!-- Firebase -->
        <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
        <script>
            // ========= FIREBASE INITIALIZATION ==========
            let db;
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBtyn-cjuhsnlEn-9Wao1tCcJfUQbf6GnY",
                    authDomain: "simarsip-apk.firebaseapp.com",
                    databaseURL: "https://simarsip-apk-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "simarsip-apk",
                    storageBucket: "simarsip-apk.firebasestorage.app",
                    messagingSenderId: "707332524030",
                    appId: "1:707332524030:web:d91551b5f199df489622af"
                };
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database();
            } catch (err) {
                console.error('Firebase init error:', err.message);
                document.getElementById("riwayat-list").innerHTML = '<div class="empty-state">Gagal memuat Firebase.</div>';
            }
    
            // ========= SHARED DUMMY DATA ==========
const sharedDummyData = [
    { id: 'dummy-1', type: 'ruangan', title: 'Rapat BEM', room: 'Ruang 101', date: '2026-01-05', status: 'approved', createdAt: new Date('2026-01-10T10:00:00Z').toISOString(), note: 'Rapat persiapan acara tahunan.' },
    { id: 'dummy-2', type: 'peralatan', title: 'Peminjaman Proyektor', equipmentName: 'Proyektor Epson', quantity: 1, date: '2026-01-20', status: 'pending', createdAt: new Date('2026-01-18T14:00:00Z').toISOString(), note: 'Untuk presentasi kelas.' },
    { id: 'dummy-3', type: 'dispensasi', title: 'Dispensasi Lomba', purpose: 'Lomba Debat Nasional', date: '2026-01-22', status: 'rejected', createdAt: new Date('2026-01-19T11:00:00Z').toISOString(), reason: 'Surat keterangan dari panitia tidak lengkap.' },
    { id: 'dummy-4', type: 'ruangan', title: 'Workshop Fotografi', room: 'Lab. Komputer', date: '2026-01-25', status: 'approved', createdAt: new Date('2026-01-20T09:00:00Z').toISOString(), note: 'Dibutuhkan akses ke 5 unit PC.' },
    { id: 'dummy-5', type: 'peralatan', title: 'Peminjaman Kamera', equipmentName: 'Kamera DSLR Canon', quantity: 2, date: '2026-01-28', status: 'pending', createdAt: new Date('2026-01-27T16:00:00Z').toISOString(), note: 'Untuk dokumentasi acara.' },
    { id: 'dummy-6', type: 'ruangan', title: 'Dekoraasi HMIF', room: 'GSG', date: '2026-01-14', status: 'approved', createdAt: new Date('2026-01-10T10:00:00Z').toISOString(), note: 'Persiapan untuk acara nanti.' },
];
    
            // ========= GLOBAL DATA STORE ==========
            let allHistoryData = [];
            
            function processDummyData() {
                sharedDummyData.forEach(item => {
                    let defaultTitle = '';
                    if (item.type === 'ruangan') defaultTitle = 'Peminjaman Ruangan';
                    else if (item.type === 'dispensasi') defaultTitle = 'Surat Dispensasi';
                    else if (item.type === 'peralatan') defaultTitle = 'Peminjaman Peralatan';
    
                    allHistoryData.push({
                        id: item.id, // Pastikan ID ditambahkan
                        title: item.title || `${defaultTitle} - ${item.room || item.purpose || item.equipmentName}`,
                        date: item.date,
                        desc: item.note || item.reason || `Jumlah: ${item.quantity}`,
                        status: item.status || 'pending',
                        rawDate: item.createdAt || item.date 
                    });
                });
            }
    
            function processCategory(categoryData, categoryKey, defaultTitle) {
                if (!categoryData) return;
                for (const key in categoryData) {
                    const item = categoryData[key];
                    allHistoryData.push({
                        id: `${categoryKey}-${key}`, // Buat ID unik untuk item Firebase
                        title: item.title || `${defaultTitle} - ${item.room || item.purpose || item.equipmentName}`,
                        date: item.date,
                        desc: item.note || item.reason || `Jumlah: ${item.quantity}`,
                        status: item.status || 'pending',
                        rawDate: item.createdAt || item.date 
                    });
                }
            }
    
            // ========= FUNGSI FETCH DATA DARI FIREBASE ==========
            function fetchHistory() {
                allHistoryData = [];
                processDummyData();
    
                if (!db) {
                    console.warn("Firebase not available. Displaying dummy data only.");
                    allHistoryData.sort((a, b) => new Date(b.rawDate) - new Date(a.rawDate));
                    renderList();
                    return;
                }
    
                const ref = db.ref('pengajuan');
                ref.on('value', (snapshot) => {
                    allHistoryData = [];
                    processDummyData();
                    
                    const data = snapshot.val();
                    if (data) {
                        processCategory(data.ruangan, 'ruangan', 'Peminjaman Ruangan');
                        processCategory(data.dispensasi, 'dispensasi', 'Surat Dispensasi');
                        processCategory(data.peralatan, 'peralatan', 'Peminjaman Peralatan');
                    }
                    
                    allHistoryData.sort((a, b) => new Date(b.rawDate) - new Date(a.rawDate));
                    renderList();
                }, (error) => {
                    console.error("Firebase read error, displaying dummy data:", error);
                    allHistoryData.sort((a, b) => new Date(b.rawDate) - new Date(a.rawDate));
                    renderList();
                });
            }
    
            // ========= FUNGSI RENDER LIST ==========
            function renderList() {
                const listContainer = document.getElementById("riwayat-list");
                listContainer.innerHTML = "";
    
                const currentFilter = document.querySelector('.tab-btn.active').getAttribute('data-filter');
                const filteredData = allHistoryData.filter(item => currentFilter === "all" || (item.status && item.status.toLowerCase() === currentFilter));
                
                if (filteredData.length === 0) {
                    listContainer.innerHTML = '<div class="empty-state">Tidak ada riwayat untuk kategori ini.</div>';
                    return;
                }
    
                filteredData.forEach(item => {
                    let statusClass = "", statusText = "", borderColor = "#0a73ff";
    
                    switch (item.status) {
                        case "approved": statusClass = "disetujui"; statusText = "DISETUJUI"; borderColor = "#2dd4bf"; break;
                        case "pending": statusClass = "menunggu"; statusText = "MENUNGGU"; borderColor = "#ffcc00"; break;
                        case "rejected": statusClass = "ditolak"; statusText = "DITOLAK"; borderColor = "#ff4444"; break;
                        default: statusClass = "menunggu"; statusText = "MENUNGGU";
                    }
                    
                    const formattedDate = item.date ? new Date(item.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Tanggal tidak tersedia';
    
                    const cardHTML = `
                        <a href="detail-riwayat.html?id=${item.id}" class="card-link">
                            <div class="card-item" style="border-left-color: ${borderColor};">
                                <div>
                                    <strong>${item.title}</strong>
                                    <span class="status ${statusClass}">${statusText}</span>
                                </div>
                                <div style="font-size:13px; margin-top:5px;">${formattedDate}</div>
                                <div style="font-size:13px; margin-top:8px; color:#444;">${item.desc}</div>
                            </div>
                        </a>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', cardHTML);
                });
            }
    
            // ========= EVENT LISTENER UNTUK TABS ==========
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderList();
                });
            });
    
            // ========= LOAD PERTAMA ==========
            fetchHistory();
    
        </script>
    </body>
    </html>
    
