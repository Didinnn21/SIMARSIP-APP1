<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kalender - SIMARSIP</title>
  <link rel="stylesheet" href="https://cdn.framework7.io/framework7/5.7.10/css/framework7.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #fafafa;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .app-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px 12px;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .app-header a {
      color: white;
      text-decoration: none;
      font-size: 24px;
      display: flex;
      line-height: 1;
    }
    
    .app-header-inner {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .app-header-title {
      font-weight: 600;
      font-size: 16px;
    }

    .page {
      padding: 16px 12px;
      padding-bottom: 80px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 8px;
    }

    .calendar-header button {
      background: #fff;
      border: 1px solid #e0e0e0;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      color: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .calendar-header button:active {
      background: #f5f5f5;
      transform: scale(0.95);
    }

    #title {
      font-weight: 700;
      font-size: 18px;
      flex: 1;
      text-align: center;
      color: #333;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 20px;
      padding: 12px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    #grid .day {
      aspect-ratio: 1;
      padding: 0;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      background: #f5f5f5;
      color: #666;
      min-height: 40px;
    }

    #grid .day:empty {
      cursor: default;
      background: transparent;
      border: none;
    }

    #grid .day.available {
      background: #a8e6cf;
      color: #2d5016;
    }

    #grid .day.pending {
      background: #ffd3b6;
      color: #8b4513;
    }

    #grid .day.borrowed {
      background: #ffaaa5;
      color: #6b0000;
    }

    #grid .day.returned {
      background: #aa96da;
      color: #3d1a5f;
    }

    #grid .day.selected-day {
      outline: 2px solid #667eea;
      outline-offset: 2px;
      transform: scale(1.05);
    }

    .legend-title {
      text-align: center;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .calendar-legend {
      background: white;
      padding: 12px;
      border-radius: 16px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .calendar-legend div {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
    }

    .legend-box {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .legend-box.available { background: #a8e6cf; }
    .legend-box.pending { background: #ffd3b6; }
    .legend-box.borrowed { background: #ffaaa5; }
    .legend-box.returned { background: #aa96da; }

    .fab {
      position: fixed;
      right: 16px;
      bottom: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s ease;
    }

    .fab:active {
      transform: translateY(2px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* FAB dropdown: icon-only, compact modal popup */
    .fab-container { position: fixed; right: 16px; bottom: 70px; z-index: 200; }
    .fab-menu { position: fixed; right: 8px; bottom: 130px; background: white; border-radius: 14px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2); padding: 10px; display: flex; flex-direction: column; gap: 6px; transition: all 0.2s ease; opacity: 0; transform: scale(0.85) translateY(8px); pointer-events: none; }
    .fab-menu[aria-hidden="false"] { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
    .fab-item { background: transparent; border: none; width: 48px; height: 48px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 26px; transition: all 0.15s ease; position: relative; }
    .fab-item:hover { background: #f5f5f5; }
    .fab-item:active { transform: scale(0.92); }
    .fab-item[data-ctx="peminjaman"] { color: #2b6cb0; }
    .fab-item[data-ctx="dispensasi"] { color: #b07b2b; }
    .fab-item[data-ctx="peralatan"] { color: #2f855a; }
    .fab-item:hover::after { content: attr(title); position: absolute; right: 56px; background: #333; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; white-space: nowrap; font-weight: 500; pointer-events: none; }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 90%;
      width: 320px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-content {
      transform: scale(1);
    }
    .modal-header {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .modal-body .booking-item {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f5f5f5;
    }
    .modal-body .booking-item:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }
    .modal-body .booking-item strong {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
    }
    .modal-body .booking-item span {
      font-size: 12px;
      color: #666;
    }
    .modal-footer {
      margin-top: 20px;
      text-align: right;
    }
    .modal-footer button {
      background-color: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="app-header" style="padding:12px 16px 18px 16px; border-bottom-left-radius:0;border-bottom-right-radius:0">
    <div class="app-header-inner">
      <div style="font-weight:700;color:#fff">Kalender</div>
      <div></div>
    </div>
  </header>

  <main class="page">
    <div class="calendar-header" style="display:flex;align-items:center;justify-content:space-between">
      <button id="prev" class="button" style="background:transparent;border:none;font-size:20px">&#x2039;</button>
      <div id="title" style="font-weight:700;font-size:18px">November 2025</div>
      <button id="next" class="button" style="background:transparent;border:none;font-size:20px">&#x203A;</button>
    </div>

    <div id="grid" class="calendar-grid" aria-live="polite"></div>

    <div class="legend-title">Status Peminjaman</div>
    <div class="calendar-legend">
      <div><span class="legend-box available"></span> Tersedia</div>
      <div><span class="legend-box pending"></span> Pending</div>
      <div><span class="legend-box borrowed"></span> Sedang dipinjam</div>
      <div><span class="legend-box returned"></span> Sudah dikembalikan</div>
    </div>

  </main>

  <div class="fab-container">
    <button id="fab" class="fab" title="Tambah">+</button>
    <div id="fabMenu" class="fab-menu" aria-hidden="true">
      <button class="fab-item" data-ctx="peminjaman" title="Peminjaman Ruangan"><i class="material-icons">domain</i></button>
      <button class="fab-item" data-ctx="dispensasi" title="Surat Dispen"><i class="material-icons">description</i></button>
      <button class="fab-item" data-ctx="peralatan" title="Peminjaman Peralatan"><i class="material-icons">devices</i></button>
    </div>
  </div>

  <div id="infoModal" class="modal-overlay">
    <div class="modal-content">
      <div id="modalHeader" class="modal-header"></div>
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button id="closeModal">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    // Calendar UI with Firebase Realtime DB integration.
    (function(){
        var grid = document.getElementById('grid');
        var title = document.getElementById('title');
        var prev = document.getElementById('prev');
        var next = document.getElementById('next');
        var fab = document.getElementById('fab');
        var current = new Date();
        var monthNames = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

        // Modal elements
        var infoModal = document.getElementById('infoModal');
        var modalHeader = document.getElementById('modalHeader');
        var modalBody = document.getElementById('modalBody');
        var closeModal = document.getElementById('closeModal');

        // Firebase state
        var firebaseReady = false;
        var remoteData = {}; // This will store data processed by date
        var dbRef = null;

        // ========= SHARED DUMMY DATA ==========
        const sharedDummyData = [
    { id: 'dummy-1', type: 'ruangan', title: 'Rapat BEM', room: 'Ruang 101', date: '2026-01-05', status: 'approved', createdAt: new Date('2026-01-10T10:00:00Z').toISOString(), note: 'Rapat persiapan acara tahunan.' },
    { id: 'dummy-2', type: 'peralatan', title: 'Peminjaman Proyektor', equipmentName: 'Proyektor Epson', quantity: 1, date: '2026-01-20', status: 'pending', createdAt: new Date('2026-01-18T14:00:00Z').toISOString(), note: 'Untuk presentasi kelas.' },
    { id: 'dummy-3', type: 'dispensasi', title: 'Dispensasi Lomba', purpose: 'Lomba Debat Nasional', date: '2026-01-22', status: 'rejected', createdAt: new Date('2026-01-19T11:00:00Z').toISOString(), reason: 'Surat keterangan dari panitia tidak lengkap.' },
    { id: 'dummy-4', type: 'ruangan', title: 'Workshop Fotografi', room: 'Lab. Komputer', date: '2026-01-25', status: 'approved', createdAt: new Date('2026-01-20T09:00:00Z').toISOString(), note: 'Dibutuhkan akses ke 5 unit PC.' },
    { id: 'dummy-5', type: 'peralatan', title: 'Peminjaman Kamera', equipmentName: 'Kamera DSLR Canon', quantity: 2, date: '2026-01-28', status: 'pending', createdAt: new Date('2026-01-27T16:00:00Z').toISOString(), note: 'Untuk dokumentasi acara.' },
    { id: 'dummy-6', type: 'ruangan', title: 'Dekoraasi HMIF', room: 'GSG', date: '2026-01-14', status: 'approved', createdAt: new Date('2026-01-10T10:00:00Z').toISOString(), note: 'Persiapan untuk acara nanti.' },
];

        // Modal functions
        function showInfoModal(date, bookings) {
            var dateParts = date.split('-');
            var formattedDate = dateParts[2] + ' ' + monthNames[parseInt(dateParts[1], 10) - 1] + ' ' + dateParts[0];
            modalHeader.textContent = 'Info untuk ' + formattedDate;
            
            modalBody.innerHTML = '';
            if (Array.isArray(bookings)) {
                bookings.forEach(function(booking) {
                    var item = document.createElement('div');
                    item.className = 'booking-item';
                    
                    // 1. Judul Pengajuan
                    var title = document.createElement('strong');
                    title.style.color = '#667eea';
                    title.textContent = booking.title || 'Pengajuan Tanpa Judul';
                    
                    // 2. Status dengan Warna
                    var status = document.createElement('span');
                    status.style.display = 'block';
                    status.style.fontWeight = '600';
                    status.style.marginBottom = '4px';
                    status.textContent = 'Status: ' + (booking.status || 'N/A').toUpperCase();
                    
                    // 3. Detail Informasi (Ruangan / Peralatan)
                    var infoDetail = document.createElement('span');
                    infoDetail.style.display = 'block';
                    infoDetail.style.color = '#333';
                    
                    if (booking.room) {
                        // Jika jenisnya Ruangan
                        infoDetail.innerHTML = 'üìç <b>Ruangan:</b> ' + booking.room;
                    } else if (booking.equipmentName) {
                        // Jika jenisnya Peralatan
                        infoDetail.innerHTML = 'üõ†Ô∏è <b>Alat:</b> ' + booking.equipmentName + ' (' + (booking.quantity || 1) + ' unit)';
                    } else if (booking.purpose) {
                        // Jika jenisnya Dispensasi
                        infoDetail.innerHTML = 'üìÑ <b>Keperluan:</b> ' + booking.purpose;
                    }

                    // 4. Catatan
                    var note = document.createElement('span');
                    note.style.display = 'block';
                    note.style.fontSize = '11px';
                    note.style.marginTop = '4px';
                    note.style.fontStyle = 'italic';
                    note.textContent = 'Catatan: ' + (booking.note || booking.reason || '-');
                    
                    item.appendChild(title);
                    item.appendChild(status);
                    item.appendChild(infoDetail);
                    item.appendChild(note);
                    modalBody.appendChild(item);
                });
            }
            infoModal.classList.add('visible');
        }

        function hideInfoModal() {
            infoModal.classList.remove('visible');
        }

        // Render function reads processed remoteData
        function render(date){
            grid.innerHTML='';
            var year = date.getFullYear();
            var month = date.getMonth();
            
            title.textContent = monthNames[month] + ' ' + year;
            
            var weekdays=['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
            weekdays.forEach(function(w){ 
              var h=document.createElement('div'); h.className='day'; h.style.fontWeight='700'; h.style.background='transparent'; h.style.color='#6b7a95'; h.textContent=w; grid.appendChild(h); 
            });
            
            var first = new Date(year, month, 1);
            var last = new Date(year, month+1, 0);
            var start = first.getDay();
            for(var i=0;i<start;i++){ 
              var e=document.createElement('div'); e.className='day'; e.style.background='transparent'; e.style.cursor='default'; grid.appendChild(e); 
            }
            
            var data = remoteData;
            for(var d=1; d<=last.getDate(); d++){
                var ymd = year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
                var bookings = data[ymd];
                
                var status = 'available';
                var labelText = 'Tersedia';
                if (bookings && bookings.length > 0) {
                    var statuses = bookings.map(b => b.status);
                    if (statuses.includes('pending')) {
                        status = 'pending'; labelText = 'Pending';
                    } else if (statuses.includes('approved')) {
                        status = 'borrowed'; labelText = 'Dipinjam';
                    } else if (statuses.includes('rejected')) {
                        // Rejected items don't color the calendar day
                    }
                }
                
                var cell = document.createElement('div');
                cell.className='day';
                cell.classList.add(status);
                
                var num = document.createElement('div');
                num.style.fontWeight='700';
                num.textContent=d;
                cell.appendChild(num);
                
                
                
                (function(ymd, cell, bookings){
                    cell.addEventListener('click', function(){
                        localStorage.setItem('selectedDate', ymd);
                        document.querySelectorAll('#grid .day.selected-day').forEach(function(el){ el.classList.remove('selected-day'); });
                        cell.classList.add('selected-day');

                        if (bookings && bookings.length > 0) {
                            showInfoModal(ymd, bookings);
                        }
                    });
                })(ymd, cell, bookings);
                
                grid.appendChild(cell);
            }
        }

        prev.addEventListener('click', function(){ current = new Date(current.getFullYear(), current.getMonth()-1,1); render(current); });
        next.addEventListener('click', function(){ current = new Date(current.getFullYear(), current.getMonth()+1,1); render(current); });

        var fabMenu = document.getElementById('fabMenu');
        function closeFabMenu(){ if(!fabMenu) return; fabMenu.setAttribute('aria-hidden','true'); }
        function openFabMenu(){ if(!fabMenu) return; fabMenu.setAttribute('aria-hidden','false'); }

        fab.addEventListener('click', function(e){
            var hidden = fabMenu.getAttribute('aria-hidden') === 'true';
            if(hidden) openFabMenu(); else closeFabMenu();
            e.stopPropagation();
        });

        document.querySelectorAll('.fab-item').forEach(function(btn){
            btn.addEventListener('click', function(){
                var ctx = this.getAttribute('data-ctx');
                if(ctx === "peminjaman") window.location.href = "peminjaman.html";
                else if(ctx === "dispensasi") window.location.href = "dispensasi.html";
                else if(ctx === "peralatan") window.location.href = "peralatan.html";
                closeFabMenu();
            });
        });

        document.addEventListener('click', function(){ closeFabMenu(); });
        closeModal.addEventListener('click', hideInfoModal);
        infoModal.addEventListener('click', function(e) { if (e.target === infoModal) hideInfoModal(); });

        function processFirebaseData(data) {
            var processed = {};
            if (!data) return {};
            function addItem(item) {
                if (!item.date) return;
                if (!processed[item.date]) processed[item.date] = [];
                processed[item.date].push(item);
            }
            if (data.ruangan) Object.values(data.ruangan).forEach(addItem);
            if (data.dispensasi) Object.values(data.dispensasi).forEach(addItem);
            if (data.peralatan) Object.values(data.peralatan).forEach(addItem);
            return processed;
        }

        function processDummyData() {
            sharedDummyData.forEach(item => {
                if (!item.date) return;
                if (!remoteData[item.date]) {
                    remoteData[item.date] = [];
                }
                remoteData[item.date].push(item);
            });
        }

        function initFirebase(){
            var script = document.createElement('script');
            script.src = 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js';
            script.onload = function(){
                var dbScript = document.createElement('script');
                dbScript.src = 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js';
                dbScript.onload = function(){
                    try{
                        var firebaseConfig = {
                            apiKey: "AIzaSyBtyn-cjuhsnlEn-9Wao1tCcJfUQbf6GnY",
                            authDomain: "simarsip-apk.firebaseapp.com",
                            databaseURL: "https://simarsip-apk-default-rtdb.asia-southeast1.firebasedatabase.app",
                            projectId: "simarsip-apk",
                            storageBucket: "simarsip-apk.firebasestorage.app",
                            messagingSenderId: "707332524030",
                            appId: "1:707332524030:web:d91551b5f199df489622af"
                        };
                        
                        if(!firebase.apps.length){
                            firebase.initializeApp(firebaseConfig);
                            dbRef = firebase.database().ref('pengajuan'); 
                            dbRef.on('value', function(snap){ 
                                var rawData = snap.val() || {};
                                remoteData = processFirebaseData(rawData);
                                processDummyData(); // Merge dummy data
                                firebaseReady = true; 
                                render(current);
                            }, function(err){ 
                                console.warn('Firebase read error:', err.message);
                                remoteData = {};
                                processDummyData(); // Load dummies on error
                                render(current);
                            });
                        }
                    } catch(e){ 
                        console.warn('Firebase init failed:', e.message);
                        remoteData = {};
                        processDummyData(); // Load dummies on failure
                        render(current);
                    }
                };
                document.head.appendChild(dbScript);
            };
            document.head.appendChild(script);
        }
        initFirebase();
    })();
  </script>

  <!-- Bottom toolbar -->
        <div class="toolbar toolbar-bottom app-toolbar">
            <div class="toolbar-inner">
                <a href="index.html" class="link link-home">
                    <i class="material-icons">home</i>
                    <span class="tabbar-label">Beranda</span>
                </a>
                <a href="calendar.html" class="link active"> 
                    <i class="material-icons">calendar_today</i>
                    <span class="tabbar-label">Kalender</span>
                </a>
                <a href="notifikasi.html" class="link">
                    <i class="material-icons">notifications</i>
                    <span class="tabbar-label">Notifikasi</span>
                </a>
            </div>
        </div>
    </div>

  <style>
    body {
      padding-bottom: calc(56px + max(0px, env(safe-area-inset-bottom)));
    }
  </style>
</body>
</html>